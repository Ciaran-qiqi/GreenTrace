# 碳币市场（CarbonUSDTMarket）开发文档

## 1. 系统架构概述

### 1.1 核心组件

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  CarbonUSDT     │    │ GreenTalesLiq   │    │ CarbonPrice     │
│  Market         │◄───┤ uidityPool      │◄───┤ Oracle          │
│                 │    │                 │    │                 │
│ 市价单+限价单    │    │ AMM流动性池      │    │ 外部API价格      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
        │                       │                       │
        │                       │                       │
        ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    价格控制体系                              │
│  指导价(Oracle) ◄─── 偏离检查 ──► 市场价(AMM)               │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 价格层级体系

1. **指导价（Reference Price）**
   - 来源：CarbonPriceOracle
   - 数据源：外部API（通过Chainlink Functions）
   - 作用：作为价格基准，防止市场操纵

2. **市场价（Market Price）**
   - 来源：AMM流动性池
   - 计算公式：`totalUsdtTokens / totalCarbonTokens`
   - 作用：实际交易执行价格

3. **限价单价格（Limit Order Price）**
   - 来源：用户设定
   - 约束：必须在指导价的合理偏离范围内
   - 作用：用户自定义交易价格

## 2. 市价单机制

### 2.1 市价买单（Market Buy）

```solidity
function marketBuy(uint256 _amount) external returns (uint256 usdtSpent)
```

**执行流程：**
1. 获取AMM池当前价格：`ammPool.getCarbonPrice()`
2. 计算所需USDT（包含池子0.3%手续费）
3. 直接调用AMM池：`ammPool.swapUsdtToCarbon()`
4. **无额外平台手续费**，只收AMM池手续费

**价格控制：**
- AMM池内置价格偏离检查
- 如果市场价与指导价偏离超过阈值，交易被阻止
- 偏离阈值：`priceDeviationThreshold`（默认10%）

### 2.2 市价卖单（Market Sell）

```solidity
function marketSell(uint256 _amount) external returns (uint256 usdtReceived)
```

**执行流程：**
1. 转移碳币到合约
2. 调用AMM池：`ammPool.swapCarbonToUsdt()`
3. 返还USDT给用户（已扣除池子手续费）

**手续费结构：**
- 仅收取AMM池手续费：0.3%
- 手续费分配：平台70% + LP提供者30%

## 3. 限价单机制

### 3.1 当前实现分析

#### 买单（Buy Order）
```solidity
function createBuyOrder(uint256 _amount, uint256 _price) external returns (uint256)
```

**当前流程：**
1. 验证金额和价格
2. 计算总USDT需求：`_amount * _price`
3. 收取挂单手续费：`totalUSDT * limitOrderFeeRate`
4. 锁定用户资金
5. 创建订单记录

#### 卖单（Sell Order）
```solidity
function createSellOrder(uint256 _amount, uint256 _price) external returns (uint256)
```

**当前流程：**
1. 锁定用户碳币
2. 收取挂单手续费（USDT支付）
3. 创建订单记录

### 3.2 缺失的价格控制机制

**当前问题：**
1. ❌ 限价单价格不受指导价约束
2. ❌ 没有价格偏离保护
3. ❌ 可能出现极端价格操纵

**需要改进：**
```solidity
// 建议添加的价格验证函数
function validateLimitOrderPrice(uint256 _price, bool _isBuy) internal view {
    uint256 referencePrice = ammPool.getOracleReferencePrice();
    require(referencePrice > 0, "Oracle price not available");
    
    uint256 maxDeviation = (referencePrice * maxLimitOrderDeviation) / 100;
    uint256 minPrice = referencePrice - maxDeviation;
    uint256 maxPrice = referencePrice + maxDeviation;
    
    require(_price >= minPrice && _price <= maxPrice, "Price deviation too large");
}
```

### 3.3 订单成交机制

```solidity
function fillOrder(uint256 _orderId) external
```

**成交流程：**
1. 验证订单状态和权限
2. 计算手续费：`fillOrderFeeRate + platformFeeRate`
3. 执行资金转移
4. 更新订单状态

**手续费分配：**
- 成交手续费：由成交方支付
- 平台手续费：由成交方支付
- 卖家实收：`totalUSDT - (fillFee + platformFee)`

## 4. 价格控制体系

### 4.1 价格偏离检查机制

**AMM池价格保护：**
```solidity
function isPriceDeviated(uint256 marketPrice) public view returns (bool) {
    uint256 referencePrice = getOracleReferencePrice();
    if (referencePrice == 0) return false;
    
    uint256 deviation = calculateDeviation(marketPrice, referencePrice);
    return deviation > priceDeviationThreshold;
}
```

**保护机制：**
- 市价单执行前检查价格偏离
- 偏离超过阈值时，交易被拒绝
- 防止闪电贷攻击和价格操纵

### 4.2 建议的限价单价格控制

**价格范围限制：**
```solidity
// 建议参数
uint256 public maxLimitOrderDeviation = 20; // 20%偏离限制
uint256 public limitOrderPriceWindow = 1 hours; // 价格有效期

// 价格验证
modifier validLimitPrice(uint256 _price, bool _isBuy) {
    uint256 referencePrice = ammPool.getOracleReferencePrice();
    uint256 deviation = calculateDeviation(_price, referencePrice);
    require(deviation <= maxLimitOrderDeviation, "Price out of range");
    _;
}
```

## 5. 手续费结构对比

### 5.1 市价单手续费

| 交易类型 | 手续费率 | 收费方 | 分配方式 |
|---------|----------|--------|----------|
| 市价买单 | 0.3% | AMM池 | 平台70% + LP30% |
| 市价卖单 | 0.3% | AMM池 | 平台70% + LP30% |

### 5.2 限价单手续费

| 费用类型 | 当前费率 | 支付时机 | 支付方 |
|---------|----------|----------|--------|
| 挂单费 | `limitOrderFeeRate` | 下单时 | 挂单方 |
| 成交费 | `fillOrderFeeRate` | 成交时 | 成交方 |
| 平台费 | `platformFeeRate` | 成交时 | 成交方 |

## 6. 风险控制建议

### 6.1 价格操纵防护

```solidity
// 建议添加的保护机制
struct PriceProtection {
    uint256 maxDailyPriceChange;    // 日最大价格变动
    uint256 maxSingleOrderSize;     // 单笔最大交易量
    uint256 priceUpdateCooldown;    // 价格更新冷却期
}
```

### 6.2 流动性保护

```solidity
// 建议的流动性保护
function validateLiquidityImpact(uint256 _amount, bool _isBuy) internal view {
    uint256 totalLiquidity = _isBuy ? totalUsdtTokens : totalCarbonTokens;
    uint256 maxImpact = totalLiquidity * maxLiquidityImpact / 10000;
    require(_amount <= maxImpact, "Order too large");
}
```

### 6.3 Oracle失效保护

```solidity
// Oracle失效时的应急机制
uint256 public oracleTimeout = 1 hours;
uint256 public lastOracleUpdate;

modifier oracleHealthy() {
    require(
        block.timestamp - lastOracleUpdate <= oracleTimeout,
        "Oracle data stale"
    );
    _;
}
```

## 7. 升级建议

### 7.1 立即需要实现

1. **限价单价格验证**
   - 添加与指导价的偏离检查
   - 实现价格范围限制

2. **订单管理优化**
   - 添加批量取消功能
   - 实现订单有效期机制

### 7.2 中期优化目标

1. **智能撮合引擎**
   - 自动匹配买卖单
   - 价格时间优先撮合

2. **高级订单类型**
   - 止损订单
   - 部分成交订单

### 7.3 长期发展方向

1. **跨链价格同步**
   - 多链价格预言机
   - 跨链套利保护

2. **MEV保护**
   - 批量拍卖机制
   - 随机延迟执行

## 8. 测试用例建议

### 8.1 价格控制测试

```javascript
describe("Price Control", function() {
  it("Should reject limit order with excessive price deviation");
  it("Should block market order when price deviated");
  it("Should allow trading within normal price range");
});
```

### 8.2 手续费测试

```javascript
describe("Fee Distribution", function() {
  it("Should correctly calculate and distribute market order fees");
  it("Should handle limit order fee collection");
  it("Should verify platform fee accumulation");
});
```

## 9. 监控指标

### 9.1 价格监控

- 市场价与指导价偏离度
- 价格波动率
- 异常价格告警

### 9.2 交易监控

- 市价单/限价单比例
- 平均成交价格
- 大额订单监控

### 9.3 风险监控

- 流动性充足度
- Oracle数据延迟
- 系统暂停次数

---

**总结：当前系统具备基础的市价单和限价单功能，但限价单缺乏与指导价的联动机制。建议优先实现价格偏离检查，确保交易价格的合理性和系统的稳定性。** 